<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="css/dashboard.css" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="./js/sessao.js"></script>
</head>
<!-- validarSessao() -->

<body onload="chamarApi()">

  <div class="grid_container">
    <aside class="aside">
      <div class="usuario_container">
        <h5>Ol√° <span id="b_usuario">usu√°rio</span>!</h5>
      </div>
      <ul>
        <li>
          <img src="img/cama.svg" /><a href="pages/inicio.html">Vis√£o geral</a>
        </li>
      </ul>
      <ul>
        <li>
          <img src="img/cama.svg" /><a href="#" style="color: #001d6c; font-weight: bold">Quarto N¬∞ 125</a>
        </li>
      </ul>
      <ul>
        <li>
          <img src="img/cama.svg" /><a href="./pages/quarto126.html">Quarto N¬∞ 126</a>
        </li>
      </ul>
      <ul>
        <li>
          <img src="img/cama.svg" /><a href="./pages/quarto127.html">Quarto N¬∞ 127</a>
          <span class="alert-icon" style="padding-left: 30px; font-size: 35px">‚ö†Ô∏è</span>
        </li>
      </ul>
    </aside>
    <header class="cabecalho">
      <ul class="navbar">
        <li>Inicial</li>
        <li>Simulador</li>
      </ul>
      <img src="img/logo.svg" />
      <ul class="navbar">
        <li>Sobre n√≥s</li>
        <li>Fale conosco</li>
      </ul>
    </header>

    <div class="clima_tempo_container">
      <h1 id="cidade">S√£o Paulo</h1>
      <div class="descricao"></div>
      <div class="infos">
        <div id="clima_tempo_temperatura">
          <i id="temp_icon" class="fa-solid fa-temperature-quarter"></i>
          <span>Temperatura:</span>
          <b id="temp_value"></b>
        </div>
        <div class="clima_tempo_umidade">
          <i id="umid_icon" class="fa-solid fa-droplet"></i>
          <span>Umidade:</span>
          <b id="umid_value"></b>
        </div>
      </div>
    </div>

    <div class="titulos_metricas">
      <span id="temperatura">Temperatura</span>
      <span id="umidade">Umidade</span>
    </div>
    <div class="container_metricas">
      <div class="container-metricas-temperaturas">
        <div id="alerta_temperatura_baixa">
          <span>Abaixo 23C¬∫</span>
        </div>
        <div id="alerta_temperatura_ideal">
          <span>Acima 23C¬∫ at√© 25C¬∫</span>
        </div>
        <div id="alerta_temperatura_alta">
          <span>Acima de 25C¬∫</span>
        </div>
      </div>

      <div class="container-metricas-umidades">
        <div id="alerta_umidade_baixa">
          <span>Abaixo de 30%</span>
        </div>
        <div id="alerta_umidade_ideal">
          <span>Acima de 30% at√© 60%</span>
        </div>
        <div id="alerta_umidade_alta">
          <span>Acima de 60%</span>
        </div>
      </div>
    </div>

    <div class="container_temperatura container bgColorTempQ125">
      <h3 class="titulo_container">Temperatura</h3>
      <p class="paragrafo_container">23¬∞C üå°Ô∏è</p>
      <span id="status-message">Temperatura Normal</span>
    </div>

    <div class="container_umidade container bgColorUmiQ125">
      <h3 class="titulo_container">Umidade</h3>
      <p class="paragrafo_container">45% üíß</p>
      <span id="status-message">Umidade Normal</span>
    </div>

    <div class="container_proximidade container">
      <h3 class="titulo_container">Proximidade</h3>
      <p class="paragrafo_container">Aberto ü™ü</p>
      <span id="status-message">Janela Aberta</span>
    </div>

    <div class="container_alerta container">
      <h3 class="titulo_container">Alerta ‚ö†Ô∏è</h3>
      <p class="paragrafo_container">Sem alertas</p>
      <span id="status-message">-</span>
    </div>

    <div class="container_grafico-temperatura">
      <canvas id="graficoTemperatura"></canvas>
    </div>

    <div class="container_grafico-umidade">
      <canvas id="graficoUmidade"></canvas>
    </div>
  </div>

  <div class="mensagem_erro"></div>

</body>

</html>

<script src="js/script.js"></script>
<script src="js/graficos.js"></script>

<script>

  async function chamarApi() {
    // const { json } = require("express");
    const apiKey = '910c4efbe73c746cce373fd23d6fdf43';
    const cidade = 'S√£o Paulo'
    const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURI(cidade)}&appid=${apiKey}&units=metric&lang=pt_br`;
    const results = await fetch(apiUrl);
    const json = await results.json();

    if (json.cod === 200) {
      mostrarInfo({
        cidade: json.name,
        pais: json.sys.country,
        temp: json.main.temp,
        umidade: json.main.humidity,
        descricao: json.weather[0].description,
        tempIcon: json.weather[0].icon
      });
    } else {
      alert("Ocoreu um erro de leitura do tempo externo...");
    }
  }

  function mostrarInfo(json) {
    document.querySelector('#cidade').innerHTML = `${json.cidade}, ${json.pais}`;

    document.querySelector('#temp_value').innerHTML = `${json.temp.toFixed(1).toString().replace('.', ',')} <sup>C¬∫</sup>`;

    document.querySelector('#umid_value').innerHTML = `${json.umidade}`;

  }


  setInterval(async function inserirClima() {
    const apiKey = '910c4efbe73c746cce373fd23d6fdf43';
    const cidade = 'S√£o Paulo'
    const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURI(cidade)}&appid=${apiKey}&units=metric&lang=pt_br`;
    const results = await fetch(apiUrl);
    const json = await results.json();

    fetch("/clima/armazenarClima", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora v√° para o arquivo routes/usuario.js
        cidadeServer: json.name,
        tempServer: json.main.temp,
        umidadeServer: json.main.humidity
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {

          console.log("M√©tricas inseridas com sucesso no banco de dados!");

        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

    return false;

  }, 5000);

</script>