<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="css/dashboard.css" />
    <link rel="shortcut icon" href="img/logo widas.png" type="image/x-icon">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"/>
    <script src="./js/sessao.js"></script>
  </head>
  <!-- validarSessao() -->

  <body onload="chamarApi()">
    <div class="grid_container">
      <aside class="aside">
        <div class="usuario_container">
          <h5>Ol√° <span id="b_usuario">usu√°rio</span>!</h5>
        </div>
        <ul>
          <li>
            <img src="img/cama.svg" /><a href="pages/inicio.html"
              >Vis√£o geral</a
            >
          </li>
        </ul>
        <ul id="ul_quartos"></ul>

        <!-- <ul>
          <li>
            <img src="img/cama.svg" /><a
              href="#"
              style="color: #001d6c; font-weight: bold"
              >Quarto N¬∞ 125</a
            >
          </li>
        </ul>
        <ul>
          <li>
            <img src="img/cama.svg" /><a href="./pages/quarto126.html"
              >Quarto N¬∞ 126</a
            >
          </li>
        </ul> -->

        <!-- <ul>
          <li>
            <img src="img/cama.svg" /><a href="./pages/quarto127.html"
              >Quarto N¬∞ 127</a
            >
            <span class="alert-icon" style="padding-left: 30px; font-size: 35px"
              >‚ö†Ô∏è</span
            >
          </li>
        </ul> -->
      </aside>
      <header class="cabecalho">
        <ul class="navbar">
          <li>Inicial</li>
          <li>Simulador</li>
          <button onclick="obterDadosGrafico()">teste chamar dados</button>
        </ul>
        <img src="img/logo.svg" />
        <ul class="navbar">
          <li>Sobre n√≥s</li>
          <li>Fale conosco</li>
        </ul>
      </header>

      <div class="clima_tempo_container">
        <h1 id="cidade">S√£o Paulo</h1>
        <div class="descricao"></div>
        <div class="infos">
          <div id="clima_tempo_temperatura">
            <i id="temp_icon" class="fa-solid fa-temperature-quarter"></i>
            <span>Temperatura:</span>
            <b id="temp_value"></b>
          </div>
          <div class="clima_tempo_umidade">
            <i id="umid_icon" class="fa-solid fa-droplet"></i>
            <span>Umidade:</span>
            <b id="umid_value"></b>
          </div>
        </div>
      </div>

      <div class="titulos_metricas">
        <span id="temperatura">Temperatura</span>
        <span id="umidade">Umidade</span>
      </div>
      <div class="container_metricas">
        <div class="container-metricas-temperaturas">
          <div id="alerta_temperatura_baixa">
            <span>Abaixo 23C¬∫</span>
          </div>
          <div id="alerta_temperatura_ideal">
            <span>Acima 23C¬∫ at√© 25C¬∫</span>
          </div>
          <div id="alerta_temperatura_alta">
            <span>Acima de 25C¬∫</span>
          </div>
        </div>

        <div class="container-metricas-umidades">
          <div id="alerta_umidade_baixa">
            <span>Abaixo de 30%</span>
          </div>
          <div id="alerta_umidade_ideal">
            <span>Acima de 30% at√© 60%</span>
          </div>
          <div id="alerta_umidade_alta">
            <span>Acima de 60%</span>
          </div>
        </div>
      </div>

      <div class="container_temperatura container bgColorTempQ125">
        <h3 class="titulo_container">Temperatura</h3>
        <p class="paragrafo_container">23¬∞C üå°Ô∏è</p>
        <span id="status-message">Temperatura Normal</span>
      </div>

      <div class="container_umidade container bgColorUmiQ125">
        <h3 class="titulo_container">Umidade</h3>
        <p class="paragrafo_container">45% üíß</p>
        <span id="status-message">Umidade Normal</span>
      </div>

      <div class="container_proximidade container">
        <h3 class="titulo_container">Proximidade</h3>
        <p class="paragrafo_container">Aberto ü™ü</p>
        <span id="status-message">Janela Aberta</span>
      </div>

      <div class="container_alerta container">
        <h3 class="titulo_container">Alerta ‚ö†Ô∏è</h3>
        <p class="paragrafo_container">Sem alertas</p>
        <span id="status-message">-</span>
      </div>

      <div id="graficos"></div>

      <div class="container_grafico-temperatura" id="grafico-temperatura"></div>

      <div class="container_grafico-umidade" id="grafico-umidade">
        <canvas id="graficoUmidade"></canvas>
      </div>
    </div>

    <div class="mensagem_erro"></div>
    <div id="graficos"></div>
  </body>
</html>

<script src="js/script.js"></script>
<script src="js/graficos.js"></script>

<script>
  var quarto_selecionado = undefined;

  async function chamarApi() {
    // const { json } = require("express");
    const apiKey = "910c4efbe73c746cce373fd23d6fdf43";
    const cidade = "S√£o Paulo";
    const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURI(
      cidade
    )}&appid=${apiKey}&units=metric&lang=pt_br`;
    const results = await fetch(apiUrl);
    const json = await results.json();

    if (json.cod === 200) {
      mostrarInfo({
        cidade: json.name,
        pais: json.sys.country,
        temp: json.main.temp,
        umidade: json.main.humidity,
        descricao: json.weather[0].description,
        tempIcon: json.weather[0].icon,
      });
    } else {
      alert("Ocoreu um erro de leitura do tempo externo...");
    }
  }

  function mostrarInfo(json) {
    document.querySelector(
      "#cidade"
    ).innerHTML = `${json.cidade}, ${json.pais}`;

    document.querySelector("#temp_value").innerHTML = `${json.temp
      .toFixed(1)
      .toString()
      .replace(".", ",")} <sup>C¬∫</sup>`;

    document.querySelector("#umid_value").innerHTML = `${json.umidade}`;
  }

  setInterval(async function inserirClima() {
    const apiKey = "910c4efbe73c746cce373fd23d6fdf43";
    const cidade = "S√£o Paulo";
    const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURI(
      cidade
    )}&appid=${apiKey}&units=metric&lang=pt_br`;
    const results = await fetch(apiUrl);
    const json = await results.json();

    fetch("/clima/armazenarClima", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora v√° para o arquivo routes/usuario.js
        cidadeServer: json.name,
        tempServer: json.main.temp,
        umidadeServer: json.main.humidity,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          console.log("M√©tricas inseridas com sucesso no banco de dados!");
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

    return false;
  }, 200000);

  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  let proximaAtualizacao;

  window.onload = exibirQuartosDoUsuario();

  // function exibirQuartosDoUsuario_original() {
  //   var quartos = JSON.parse(sessionStorage.quartos);
  //   quartos.forEach((item) => {
  //     document.getElementById("ul_quartos").innerHTML += `
  //       <button onclick="exibirQuartos(${item.idQuarto})" id="ul_quartos${item.idQuarto}">${item.numero}</button>
  //       `;

  //     document.getElementById("graficos").innerHTML += `
  //           <div id="grafico${item.idQuarto}" class="display-none">
  //               <h3 class="tituloGraficos">
  //                   <span id="tituloQuarto${item.idQuarto}">${item.numero}</span>
  //               </h3>
  //               <div class="graph">
  //                   <canvas id="myChartCanvas${item.idQuarto}"></canvas>
  //               </div>
  //               <div class="label-captura">
  //                   <p id="avisoCaptura${item.idQuarto}" style="color: white"></p>
  //               </div>
  //           </div>
  //       `;

  //     function exibirQuartos(idQuarto) {
  //       let todosOsGraficos = JSON.parse(sessionStorage.quartos);

  //       for (i = 0; i < todosOsGraficos.length; i++) {
  //         // exibindo - ou n√£o - o gr√°fico
  //         if (todosOsGraficos[i].id != idQuarto) {
  //           let elementoAtual = document.getElementById(
  //             `grafico${todosOsGraficos[i].id}`
  //           );
  //           if (elementoAtual.classList.contains("display-block")) {
  //             elementoAtual.classList.remove("display-block");
  //           }
  //           elementoAtual.classList.add("display-none");

  //           // alterando estilo do bot√£o
  //           let btnAtual = document.getElementById(
  //             `btnAquario${todosOsGraficos[i].id}`
  //           );
  //           if (btnAtual.classList.contains("btn-pink")) {
  //             btnAtual.classList.remove("btn-pink");
  //           }
  //           btnAtual.classList.add("btn-white");
  //         }
  //       }

  //       // exibindo - ou n√£o - o gr√°fico
  //       let graficoExibir = document.getElementById(`grafico${idAquario}`);
  //       graficoExibir.classList.remove("display-none");
  //       graficoExibir.classList.add("display-block");

  //       // alterando estilo do bot√£o
  //       let btnExibir = document.getElementById(`btnAquario${idAquario}`);
  //       btnExibir.classList.remove("btn-white");
  //       btnExibir.classList.add("btn-pink");
  //     }

  //     obterDadosGrafico(item.id);
  //   });

  //   if (aquarios.length > 0) {
  //     exibirQuartos(aquarios[0].id);
  //   }
  // }

  function exibirQuartosDoUsuario() {
    var quartos = JSON.parse(sessionStorage.quartos);
    quartos.forEach((item) => {
      document.getElementById("ul_quartos").innerHTML += `
        
        <button 
          class="btn_quarto" 
          onclick="obterDadosGrafico(${item.idQuarto}, ${item.numero})"
          id="ul_quartos${item.numero}">
           ${item.numero}
        </button>
        
      `;

      document.getElementById("grafico-temperatura").innerHTML += `
            <div id="grafico${item.idQuarto}" class="display-none">
                <div class="container_grafico-temperatura">
                    <canvas id="graficoTemperatura${item.idQuarto}"></canvas>
                </div>
                <div class="container_grafico-umidade" 
                    <canvas id="graficoUmidade${item.idQuarto}"></canvas>
                </div>
                <div class="label-captura">
                    <p id="avisoCaptura${item.idQuarto}" style="color: white"></p>
                </div>
            </div>
        `;

      obterDadosGrafico(item.id);
    });
  }

  function alterarTitulo(idQuarto) {
    var tituloQuarto = document.getElementById(`tituloQuarto${idQuarto}`);
    var descricao = JSON.parse(sessionStorage.Quartos).find(
      (item) => item.id == idQuarto
    ).descricao;
    tituloQuarto.innerHTML =
      "√öltimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>" +
      descricao +
      "</span>";
  }

  // a partir daqui come√ßam as fun√ß√µes dos gr√°ficos

  // O gr√°fico √© constru√≠do com tr√™s fun√ß√µes:
  // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gr√°fico da primeira vez
  // 2. plotarGrafico -> Monta o gr√°fico com os dados trazidos e exibe em tela
  // 3. atualizarGrafico -> Atualiza o gr√°fico, trazendo novamente dados do Banco

  // Esta fun√ß√£o *obterDadosGrafico* busca os √∫ltimos dados inseridos em tabela de medidas.
  // para, quando carregar o gr√°fico da primeira vez, j√° trazer com v√°rios dados.
  // A fun√ß√£o *obterDadosGrafico* tamb√©m invoca a fun√ß√£o *plotarGrafico*

  //     Se quiser alterar a busca, ajuste as regras de neg√≥cio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models

  function obterDadosGrafico(idQuarto, numero) {
    console.log("idQuarto SELECIONADO: ", idQuarto);

    // obterDadosGrafico(idQuarto)

    // joao.paula@sptech.school - mandar zip do projeto

    // fetch -> passando idQuarto
    // no then() -> tratar a resposta para gerar o gr√°fico
    // caso j√° exista um gr√°fico, veja a fun√ß√£o "atualizarGrafico()" que desmonta e remonta o gr√°fico

    fetch(`/medidas/ultimas/${idQuarto}`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();

            plotarGrafico(resposta, idQuarto);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obten√ß√£o dos dados p/ gr√°fico: ${error.message}`
        );
      });
  }

  function plotarGrafico(resposta, idQuarto) {
    console.log("iniciando plotagem do gr√°fico...");

    // Criando estrutura para plotar gr√°fico - labels
    let labels = [];

    // Criando estrutura para plotar gr√°fico - dados
    let dados = {
      labels: labels,
      datasets: [
        {
          label: "Umidade",
          data: [],
          fill: false,
          borderColor: "rgb(75, 192, 192)",
          tension: 0.1,
        },
        {
          label: "Temperatura",
          data: [],
          fill: false,
          borderColor: "rgb(199, 52, 52)",
          tension: 0.1,
        },
      ],
    };

    console.log("----------------------------------------------");
    console.log(
      'Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":'
    );
    console.log(resposta);

    // Inserindo valores recebidos em estrutura para plotar o gr√°fico
    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      labels.push(registro.momento_grafico);
      dados.datasets[0].data.push(registro.umidade);
      dados.datasets[1].data.push(registro.temperatura);
      //dados.datasets[2].data.push(registro.proximidade);
    }

    console.log("----------------------------------------------");
    console.log("O gr√°fico ser√° plotado com os respectivos valores:");
    console.log("Labels:");
    console.log(labels);
    console.log("Dados:");
    console.log(dados.datasets);
    console.log("----------------------------------------------");

    // Criando estrutura para plotar gr√°fico - config
    const config = {
      type: "line",
      data: dados,
    };

    // Adicionando gr√°fico criado em div na tela
    let myChart = new Chart(
      document.getElementById(`graficoTemperatura${idQuarto}`),
      config
    );

    setTimeout(() => atualizarGrafico(idQuarto, dados, myChart), 2000);
  }

  function atualizarGrafico(idQuarto, dados, myChart) {
    fetch(`/medidas/tempo-real/${idQuarto}`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {
            obterdados(idQuarto);
            // alertar(novoRegistro, idAquario);
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gr√°fico:`);
            console.log(dados);

            let avisoCaptura = document.getElementById(
              `avisoCaptura${idQuarto}`
            );
            avisoCaptura.innerHTML = "";

            if (
              novoRegistro[0].momento_grafico ==
              dados.labels[dados.labels.length - 1]
            ) {
              console.log(
                "---------------------------------------------------------------"
              );
              console.log(
                "Como n√£o h√° dados novos para captura, o gr√°fico n√£o atualizar√°."
              );
              avisoCaptura.innerHTML =
                "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como n√£o h√° dados novos a exibir, o gr√°fico n√£o atualizar√°.";
              console.log("Hor√°rio do novo dado capturado:");
              console.log(novoRegistro[0].momento_grafico);
              console.log("Hor√°rio do √∫ltimo dado capturado:");
              console.log(dados.labels[dados.labels.length - 1]);
              console.log(
                "---------------------------------------------------------------"
              );
            } else {
              // tirando e colocando valores no gr√°fico
              dados.labels.shift(); // apagar o primeiro
              dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

              dados.datasets[0].data.shift(); // apagar o primeiro de umidade
              dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

              dados.datasets[1].data.shift(); // apagar o primeiro de temperatura
              dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

              myChart.update();
            }

            // Altere aqui o valor em ms se quiser que o gr√°fico atualize mais r√°pido ou mais devagar
            proximaAtualizacao = setTimeout(
              () => atualizarGrafico(idQuarto, dados, myChart),
              2000
            );
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
          // Altere aqui o valor em ms se quiser que o gr√°fico atualize mais r√°pido ou mais devagar
          proximaAtualizacao = setTimeout(
            () => atualizarGrafico(idQuarto, dados, myChart),
            2000
          );
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obten√ß√£o dos dados p/ gr√°fico: ${error.message}`
        );
      });
  }
</script>
